rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return request.auth.uid == uid;
    }
    
    function isVerified() {
      return resource.data.verification.isVerified == true;
    }
    
    function isAdmin() {
      return request.auth.token.admin == true;
    }
    
    function isParticipant(participants) {
      return request.auth.uid in participants;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated(); // Allow authenticated users to read user profiles
      
      allow create: if isAuthenticated() && isOwner(userId) && 
        request.resource.data.uid == request.auth.uid;
      
      allow update: if isAuthenticated() && isOwner(userId) &&
        // Prevent users from updating verification status directly
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['verification.isVerified', 'verification.verificationStatus']) &&
        // Prevent users from updating wallet balance directly
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['wallet.balance', 'wallet.pendingBalance', 'wallet.totalEarnings']);
      
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // Items collection
    match /items/{itemId} {
      allow read: if true; // Allow public read access for browsing listings
      
      allow create: if isAuthenticated() && 
        request.resource.data.ownerId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
        isOwner(resource.data.ownerId) &&
        // Prevent owners from updating ratings and stats directly
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['ratings', 'stats.views', 'stats.totalRentals', 'stats.revenue']) &&
        // Only allow featured updates by admins
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['featured']) || isAdmin());
      
      allow delete: if isAuthenticated() && 
        (isOwner(resource.data.ownerId) || isAdmin());
    }
    
    // Rentals collection
    match /rentals/{rentalId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.ownerId) ||
        isOwner(resource.data.renterId) ||
        isAdmin()
      );

      allow create: if isAuthenticated() &&
        // Check if user is verified by reading their user document
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.verification.isVerified == true &&
        request.resource.data.renterId == request.auth.uid;

      allow update: if isAuthenticated() && (
        // Owner can approve/reject requests and update status
        (isOwner(resource.data.ownerId) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'dates.confirmedStart', 'dates.confirmedEnd', 'completion.ownerConfirmed', 'updatedAt', 'timeline'])) ||

        // Renter can confirm completion
        (isOwner(resource.data.renterId) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['completion.renterConfirmed', 'updatedAt', 'timeline'])) ||

        // Both can update actual start/end times and damage reports
        ((isOwner(resource.data.ownerId) || isOwner(resource.data.renterId)) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['dates.actualStart', 'dates.actualEnd', 'completion.damageReported', 'updatedAt', 'timeline'])) ||

        // System/Admin updates (payment processing, escrow, Paymob webhooks, etc.)
        isAdmin()
      );

      allow delete: if isAdmin();
    }
    
    // Chats collection
    match /chats/{chatId} {
      allow read: if isAuthenticated() &&
        isParticipant(resource.data.participants);

      allow create: if isAuthenticated() &&
        isParticipant(request.resource.data.participants) &&
        request.auth.uid in request.resource.data.participants;

      allow update: if isAuthenticated() &&
        isParticipant(resource.data.participants) &&
        // Only allow updating lastMessage and metadata
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastMessage', 'metadata', 'updatedAt', 'participantsKey']);

      allow delete: if isAuthenticated() &&
        isParticipant(resource.data.participants);
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
          isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
        
        allow create: if isAuthenticated() && 
          request.resource.data.senderId == request.auth.uid &&
          isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
        
        allow update: if isAuthenticated() && 
          isOwner(resource.data.senderId) &&
          // Only allow updating status and metadata (for editing/deleting)
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'metadata']);
        
        allow delete: if isAuthenticated() && 
          (isOwner(resource.data.senderId) || isAdmin());
      }
    }
    
    // Reviews collection
    match /reviews/{reviewId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
        request.resource.data.reviewerId == request.auth.uid &&
        // Ensure reviewer was part of the rental
        exists(/databases/$(database)/documents/rentals/$(request.resource.data.rentalId)) &&
        (get(/databases/$(database)/documents/rentals/$(request.resource.data.rentalId)).data.ownerId == request.auth.uid ||
         get(/databases/$(database)/documents/rentals/$(request.resource.data.rentalId)).data.renterId == request.auth.uid);
      
      allow update: if isAuthenticated() && (
        // Reviewer can update their review
        (isOwner(resource.data.reviewerId) && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['review', 'ratings', 'updatedAt'])) ||
        
        // Reviewee can add response
        (isOwner(resource.data.revieweeId) && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['response', 'updatedAt'])) ||
        
        // Any user can vote helpful
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['helpfulVotes']) ||
        
        // Admin can update status and flags
        isAdmin()
      );
      
      allow delete: if isAuthenticated() && 
        (isOwner(resource.data.reviewerId) || isAdmin());
    }
    
    // Wallet transactions collection
    match /wallet_transactions/{transactionId} {
      allow read: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin());
      
      allow create: if isAdmin(); // Only system can create transactions
      
      allow update: if isAdmin(); // Only system can update transactions
      
      allow delete: if isAdmin();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
        isOwner(resource.data.userId);
      
      allow create: if isAdmin(); // Only system can create notifications
      
      allow update: if isAuthenticated() && 
        isOwner(resource.data.userId) &&
        // Users can only update status and readAt
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'readAt']);
      
      allow delete: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin());
    }
    
    // Categories collection (reference data)
    match /categories/{categoryId} {
      allow read: if true; // Public read access
      allow write: if isAdmin(); // Only admins can modify categories
    }
    
    // Commission transactions collection
    match /commission_transactions/{transactionId} {
      allow read: if isAuthenticated() &&
        (resource.data.ownerId == request.auth.uid || isAdmin());

      allow create: if isAdmin(); // Only system can create commission transactions

      allow update: if isAdmin(); // Only system can update commission transactions

      allow delete: if isAdmin();
    }

    // User subscriptions collection
    match /user_subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Referral codes collection
    match /referral_codes/{codeId} {
      // Allow reading own codes and code validation queries
      allow read: if isAuthenticated() && (isOwner(resource.data.userId) ||
        // Allow reading for code uniqueness and validation checks
        true);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Referrals collection
    match /referrals/{referralId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.referrerId) ||
        isOwner(resource.data.refereeId)
      );
      allow create: if isAuthenticated() && isOwner(request.resource.data.refereeId);
      allow update: if isAuthenticated() && (
        isOwner(resource.data.referrerId) ||
        isOwner(resource.data.refereeId) ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }

    // User referral stats collection
    match /user_referral_stats/{statsId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Saved searches collection
    match /saved_searches/{searchId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Search history collection
    match /search_history/{historyId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Search analytics collection
    match /search_analytics/{analyticsId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Escrow payments collection
    match /escrow_payments/{paymentId} {
      allow read: if isAuthenticated() && (
        // Users can read escrow payments for their rentals
        exists(/databases/$(database)/documents/rentals/$(resource.data.rentalId)) &&
        (get(/databases/$(database)/documents/rentals/$(resource.data.rentalId)).data.ownerId == request.auth.uid ||
         get(/databases/$(database)/documents/rentals/$(resource.data.rentalId)).data.renterId == request.auth.uid) ||
        isAdmin()
      );
      allow create: if isAdmin(); // Only system can create escrow payments
      allow update: if isAdmin(); // Only system can update escrow payments
      allow delete: if isAdmin();
    }

    // Damage claims collection
    match /damage_claims/{claimId} {
      allow read: if isAuthenticated() && (
        // Users can read damage claims for their rentals
        exists(/databases/$(database)/documents/rentals/$(resource.data.rentalId)) &&
        (get(/databases/$(database)/documents/rentals/$(resource.data.rentalId)).data.ownerId == request.auth.uid ||
         get(/databases/$(database)/documents/rentals/$(resource.data.rentalId)).data.renterId == request.auth.uid) ||
        isAdmin()
      );
      allow create: if isAuthenticated() && (
        // Users can create damage claims for their rentals
        exists(/databases/$(database)/documents/rentals/$(request.resource.data.rentalId)) &&
        (get(/databases/$(database)/documents/rentals/$(request.resource.data.rentalId)).data.ownerId == request.auth.uid ||
         get(/databases/$(database)/documents/rentals/$(request.resource.data.rentalId)).data.renterId == request.auth.uid)
      );
      allow update: if isAuthenticated() && (
        isOwner(resource.data.claimedBy) ||
        // Rental participants can update claims
        (exists(/databases/$(database)/documents/rentals/$(resource.data.rentalId)) &&
         (get(/databases/$(database)/documents/rentals/$(resource.data.rentalId)).data.ownerId == request.auth.uid ||
          get(/databases/$(database)/documents/rentals/$(resource.data.rentalId)).data.renterId == request.auth.uid)) ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }

    // Ad impressions collection
    match /ad_impressions/{impressionId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated(); // Users can record their own impressions
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAdmin();
    }

    // Ad clicks collection
    match /ad_clicks/{clickId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated(); // Users can record their own clicks
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAdmin();
    }

    // Ad campaigns collection
    match /ad_campaigns/{campaignId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Platform revenue collection
    match /platform_revenue/{revenueId} {
      allow read: if request.auth.token.admin == true; // Only admins can view revenue data

      allow create: if request.auth.token.admin == true; // Only system can create revenue records

      allow update: if request.auth.token.admin == true; // Only system can update revenue records

      allow delete: if request.auth.token.admin == true;
    }

    // Platform costs collection
    match /platform_costs/{costId} {
      allow read: if isAdmin(); // Only admins can view platform costs
      allow create: if isAdmin(); // Only system can create cost records
      allow update: if isAdmin(); // Only system can update cost records
      allow delete: if isAdmin();
    }

    // Admin logs collection
    match /admin_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if false; // Logs are immutable
      allow delete: if false; // Logs should not be deleted
    }
    
    // Cloud Storage rules for file uploads
    match /user_uploads/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner(userId);
    }
    
    // Public files (category icons, etc.)
    match /public/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}

// Cloud Storage Security Rules
service firebase.storage {
  match /b/{bucket}/o {
    
    // User profile pictures and verification documents
    match /users/{userId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        request.auth.uid == userId &&
        // Limit file size to 10MB
        request.resource.size < 10 * 1024 * 1024 &&
        // Only allow image files
        request.resource.contentType.matches('image/.*');
    }
    
    // Item images
    match /items/{itemId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        // Verify user owns the item
        exists(/databases/$(database)/documents/items/$(itemId)) &&
        get(/databases/$(database)/documents/items/$(itemId)).data.ownerId == request.auth.uid &&
        // Limit file size to 10MB
        request.resource.size < 10 * 1024 * 1024 &&
        // Only allow image files
        request.resource.contentType.matches('image/.*');
    }
    
    // Chat images
    match /chats/{chatId}/{fileName} {
      allow read: if request.auth != null &&
        exists(/databases/$(database)/documents/chats/$(chatId)) &&
        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      
      allow write: if request.auth != null &&
        exists(/databases/$(database)/documents/chats/$(chatId)) &&
        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
        // Limit file size to 10MB
        request.resource.size < 10 * 1024 * 1024 &&
        // Only allow image files
        request.resource.contentType.matches('image/.*');
    }
    
    // Review images
    match /reviews/{reviewId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        exists(/databases/$(database)/documents/reviews/$(reviewId)) &&
        get(/databases/$(database)/documents/reviews/$(reviewId)).data.reviewerId == request.auth.uid &&
        // Limit file size to 10MB
        request.resource.size < 10 * 1024 * 1024 &&
        // Only allow image files
        request.resource.contentType.matches('image/.*');
    }
    
    // Public assets (category icons, app assets)
    match /public/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && 
        request.auth.token.admin == true;
    }
    
    // Deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
