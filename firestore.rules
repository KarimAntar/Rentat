// Rules updated to allow authenticated users to read and list chats
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return request.auth.uid == uid;
    }
    
    function isVerified() {
      return resource.data.verification.isVerified == true;
    }
    
    function isAdmin() {
      return request.auth != null && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    function isParticipant(participants) {
      return participants.hasAny([request.auth.uid]);
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated(); // Allow authenticated users to read user profiles
      
      allow create: if isAuthenticated() && isOwner(userId) && 
        request.resource.data.uid == request.auth.uid;
      
      allow update: if isAuthenticated() && isOwner(userId) &&
        // Prevent users from updating verification status directly
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['verification.isVerified', 'verification.verificationStatus']) &&
        // Prevent users from updating wallet balance directly
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['wallet.balance', 'wallet.pendingBalance', 'wallet.totalEarnings']);
      
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // Items collection
    match /items/{itemId} {
      allow read: if true; // Allow public read access for browsing listings

      allow create: if isAuthenticated() &&
        request.resource.data.ownerId == request.auth.uid;

      allow update: if isAuthenticated() &&
        (isOwner(resource.data.ownerId) &&
         // Prevent owners from updating ratings and stats directly
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['ratings', 'stats.views', 'stats.totalRentals', 'stats.revenue']) &&
         // Only allow featured updates by admins
         (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['featured']) || isAdmin())) ||
        // Allow admins to update status, featured, and moderation fields
        (isAdmin() &&
         request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'featured', 'suspendedAt', 'suspensionReason']));

      allow delete: if isAuthenticated() &&
        (isOwner(resource.data.ownerId) || isAdmin());
    }
    
    // Rentals collection
    match /rentals/{rentalId} {
      // Allow reading rentals for availability checking (by itemId)
      // or if user is involved in the rental
      allow read: if isAuthenticated() && (
        isOwner(resource.data.ownerId) ||
        isOwner(resource.data.renterId) ||
        isAdmin()
      );
      
      // Allow querying rentals by itemId for availability (limited fields exposed)
      allow list: if isAuthenticated();

      allow create: if isAuthenticated() &&
        // Check if user is verified by reading their user document
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.verification.isVerified == true &&
        request.resource.data.renterId == request.auth.uid;

      allow update: if isAuthenticated() && (
        // Owner can approve/reject requests and update status
        (isOwner(resource.data.ownerId) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'dates.confirmedStart', 'dates.confirmedEnd', 'completion.ownerConfirmed', 'updatedAt', 'timeline', 'handover'])) ||

        // Renter can confirm completion and handover
        (isOwner(resource.data.renterId) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['completion.renterConfirmed', 'updatedAt', 'timeline', 'handover'])) ||

        // Both can update actual start/end times and damage reports
        ((isOwner(resource.data.ownerId) || isOwner(resource.data.renterId)) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['dates.actualStart', 'dates.actualEnd', 'completion.damageReported', 'updatedAt', 'timeline'])) ||

        // Both owner and renter can raise disputes
        ((isOwner(resource.data.ownerId) || isOwner(resource.data.renterId)) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['dispute', 'status', 'updatedAt', 'timeline']) &&
         resource.data.status in ['active', 'completed']) ||

        // Moderators can resolve disputes
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isModerator == true ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true) &&
         request.resource.data.dispute.status == 'resolved') ||

        // System/Admin updates (payment processing, escrow, Paymob webhooks, etc.)
        isAdmin()
      );

      allow delete: if isAdmin();
    }
    
    // Chats collection - updated for item-specific chats
    match /chats/{chatId} {
      allow read, list: if isAuthenticated(); // Allow all authenticated users to query chats by participantsKey

      allow create: if isAuthenticated() &&
        request.auth.uid in request.resource.data.participants;

      allow update: if isAuthenticated() &&
        request.auth.uid in resource.data.participants &&
        // Only allow updating lastMessage, metadata, participants, and participantsKey
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastMessage', 'metadata', 'updatedAt', 'participants', 'participantsKey']);

      allow delete: if isAuthenticated() &&
        request.auth.uid in resource.data.participants;

      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() &&
          exists(/databases/$(database)/documents/chats/$(chatId)) &&
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;

        allow create: if isAuthenticated() &&
          request.resource.data.senderId == request.auth.uid;

        allow update: if isAuthenticated() && (
          // Message sender can update status and metadata (for editing/deleting)
          (isOwner(resource.data.senderId) &&
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'metadata'])) ||
          // Chat participants can update read status (add themselves to readBy array)
          (exists(/databases/$(database)/documents/chats/$(chatId)) &&
           request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']) &&
           // Ensure they're only adding their own UID to readBy array
           request.resource.data.status.readBy.hasAll(resource.data.status.readBy) &&
           request.resource.data.status.readBy.hasAny([request.auth.uid]))
        );

        allow delete: if isAuthenticated() &&
          (isOwner(resource.data.senderId) || isAdmin());
      }
    }
    
    // Reviews collection
    match /reviews/{reviewId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
        request.resource.data.reviewerId == request.auth.uid &&
        // Ensure reviewer was part of the rental
        exists(/databases/$(database)/documents/rentals/$(request.resource.data.rentalId)) &&
        (get(/databases/$(database)/documents/rentals/$(request.resource.data.rentalId)).data.ownerId == request.auth.uid ||
         get(/databases/$(database)/documents/rentals/$(request.resource.data.rentalId)).data.renterId == request.auth.uid);
      
      allow update: if isAuthenticated() && (
        // Reviewer can update their review
        (isOwner(resource.data.reviewerId) && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['review', 'ratings', 'updatedAt'])) ||
        
        // Reviewee can add response
        (isOwner(resource.data.revieweeId) && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['response', 'updatedAt'])) ||
        
        // Any user can vote helpful
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['helpfulVotes']) ||
        
        // Admin can update status and flags
        isAdmin()
      );
      
      allow delete: if isAuthenticated() && 
        (isOwner(resource.data.reviewerId) || isAdmin());
    }
    
    // Wallet transactions collection
    match /wallet_transactions/{transactionId} {
      allow read: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin());
      
      allow create: if isAdmin(); // Only system can create transactions
      
      allow update: if isAdmin(); // Only system can update transactions
      
      allow delete: if isAdmin();
    }
    
    // Paymob transactions collection (audit trail)
    match /paymob_transactions/{transactionId} {
      allow read: if isAuthenticated() &&
        // Users can read Paymob transactions for their rentals
        (exists(/databases/$(database)/documents/rentals/$(resource.data.rentalId)) &&
         (get(/databases/$(database)/documents/rentals/$(resource.data.rentalId)).data.ownerId == request.auth.uid ||
          get(/databases/$(database)/documents/rentals/$(resource.data.rentalId)).data.renterId == request.auth.uid) ||
         isAdmin());
      
      allow create: if false; // Only system (backend) can create
      allow update: if false; // Only system can update
      allow delete: if false; // Immutable audit trail
    }
    
    // Payout requests collection
    match /payout_requests/{requestId} {
      allow read: if isAuthenticated() &&
        (isOwner(resource.data.userId) || isAdmin());
      
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      
      allow update: if isAdmin(); // Only admins can process payouts
      
      allow delete: if isAdmin();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() &&
        isOwner(resource.data.userId);

      allow create: if isAuthenticated(); // Allow authenticated users to create notifications

      allow update: if isAuthenticated() &&
        isOwner(resource.data.userId) &&
        // Users can only update status and readAt
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'readAt']);

      allow delete: if isAuthenticated() &&
        (isOwner(resource.data.userId) || isAdmin());
    }

    // Dashboard notifications collection (new)
    match /dashboard_notifications/{notificationId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAdmin(); // Only system/admin creates these
      allow update: if isAuthenticated() && isOwner(resource.data.userId) && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Deposits collection
    match /deposits/{depositId} {
      allow read: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAdmin(); // Only admins can update deposits (hold, release)
      allow delete: if isAdmin();
    }
    
    // Categories collection (reference data)
    match /categories/{categoryId} {
      allow read: if true; // Public read access
      allow write: if isAdmin(); // Only admins can modify categories
    }
    
    // Commission transactions collection
    match /commission_transactions/{transactionId} {
      allow read: if isAuthenticated() &&
        (resource.data.ownerId == request.auth.uid || isAdmin());

      allow create: if isAdmin(); // Only system can create commission transactions

      allow update: if isAdmin(); // Only system can update commission transactions

      allow delete: if isAdmin();
    }

    // User subscriptions collection
    match /user_subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Referral codes collection
    match /referral_codes/{codeId} {
      // Allow reading own codes and code validation queries
      allow read: if isAuthenticated() && (isOwner(resource.data.userId) ||
        // Allow reading for code uniqueness and validation checks
        true);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Referrals collection
    match /referrals/{referralId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.referrerId) ||
        isOwner(resource.data.refereeId)
      );
      allow create: if isAuthenticated() && isOwner(request.resource.data.refereeId);
      allow update: if isAuthenticated() && (
        isOwner(resource.data.referrerId) ||
        isOwner(resource.data.refereeId) ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }

    // User referral stats collection
    match /user_referral_stats/{statsId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Saved searches collection
    match /saved_searches/{searchId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Favorites collection
    match /favorites/{favoriteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow update: if false; // Favorites don't need updates, only create/delete
    }

    // Search history collection
    match /search_history/{historyId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Search analytics collection
    match /search_analytics/{analyticsId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Escrow payments collection
    match /escrow_payments/{paymentId} {
      allow read: if isAuthenticated() && (
        // Users can read escrow payments for their rentals
        exists(/databases/$(database)/documents/rentals/$(resource.data.rentalId)) &&
        (get(/databases/$(database)/documents/rentals/$(resource.data.rentalId)).data.ownerId == request.auth.uid ||
         get(/databases/$(database)/documents/rentals/$(resource.data.rentalId)).data.renterId == request.auth.uid) ||
        isAdmin()
      );
      allow create: if isAdmin(); // Only system can create escrow payments
      allow update: if isAdmin(); // Only system can update escrow payments
      allow delete: if isAdmin();
    }

    // Damage claims collection
    match /damage_claims/{claimId} {
      allow read: if isAuthenticated() && (
        // Users can read damage claims for their rentals
        exists(/databases/$(database)/documents/rentals/$(resource.data.rentalId)) &&
        (get(/databases/$(database)/documents/rentals/$(resource.data.rentalId)).data.ownerId == request.auth.uid ||
         get(/databases/$(database)/documents/rentals/$(resource.data.rentalId)).data.renterId == request.auth.uid) ||
        isAdmin()
      );
      allow create: if isAuthenticated() && (
        // Users can create damage claims for their rentals
        exists(/databases/$(database)/documents/rentals/$(request.resource.data.rentalId)) &&
        (get(/databases/$(database)/documents/rentals/$(request.resource.data.rentalId)).data.ownerId == request.auth.uid ||
         get(/databases/$(database)/documents/rentals/$(request.resource.data.rentalId)).data.renterId == request.auth.uid)
      );
      allow update: if isAuthenticated() && (
        isOwner(resource.data.claimedBy) ||
        // Rental participants can update claims
        (exists(/databases/$(database)/documents/rentals/$(resource.data.rentalId)) &&
         (get(/databases/$(database)/documents/rentals/$(resource.data.rentalId)).data.ownerId == request.auth.uid ||
          get(/databases/$(database)/documents/rentals/$(resource.data.rentalId)).data.renterId == request.auth.uid)) ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }

    // Ad impressions collection
    match /ad_impressions/{impressionId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated(); // Users can record their own impressions
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAdmin();
    }

    // Ad clicks collection
    match /ad_clicks/{clickId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated(); // Users can record their own clicks
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAdmin();
    }

    // Ad campaigns collection
    match /ad_campaigns/{campaignId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Platform revenue collection
    match /platform_revenue/{revenueId} {
      allow read: if isAdmin(); // Only admins can view revenue data

      allow create: if isAdmin(); // Only system can create revenue records

      allow update: if isAdmin(); // Only system can update revenue records

      allow delete: if isAdmin();
    }

    // Platform costs collection
    match /platform_costs/{costId} {
      allow read: if isAdmin(); // Only admins can view platform costs
      allow create: if isAdmin(); // Only system can create cost records
      allow update: if isAdmin(); // Only system can update cost records
      allow delete: if isAdmin();
    }

    // Admins collection - for admin dashboard authentication
    match /admins/{adminId} {
      // Allow authenticated users to read their own admin document
      allow read: if isAuthenticated() && isOwner(adminId);
      // Only allow creation/updates through backend (Firebase Admin SDK)
      allow write: if false;
    }

    // Admin logs collection
    match /admin_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if false; // Logs are immutable
      allow delete: if false; // Logs should not be deleted
    }

    // Disputes collection - for admin dashboard
    match /disputes/{disputeId} {
      allow read: if isAuthenticated() && (
        // Users involved in dispute can read
        resource.data.reportedBy == request.auth.uid ||
        resource.data.reportedAgainst == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAdmin(); // Only admins can update disputes
      allow delete: if isAdmin();
    }

    // Moderation queue collection - for admin dashboard
    match /moderation_queue/{queueId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated(); // Users can flag content
      allow update: if isAdmin(); // Only admins can moderate
      allow delete: if isAdmin();
    }

    // Feature flags collection - for admin dashboard
    match /feature_flags/{flagId} {
      allow read: if true; // Public read for client-side feature checking
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Notification campaigns collection - for admin dashboard
    match /notification_campaigns/{campaignId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Platform settings collection - for admin dashboard
    match /platform_settings/{settingsId} {
      allow read: if isAuthenticated(); // Users need to read commission rates
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Platform config collection - for commission settings
    match /platform_config/{configId} {
      allow read: if isAuthenticated(); // Allow authenticated users to read commission config
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Cloud Storage rules for file uploads
    match /user_uploads/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner(userId);
    }
    
    // Public files (category icons, etc.)
    match /public/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
