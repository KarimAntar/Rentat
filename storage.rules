rules_version = '2';

// Cloud Storage Security Rules
service firebase.storage {
  match /b/{bucket}/o {
    
    // User profile pictures and verification documents
    match /users/{userId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        request.auth.uid == userId &&
        // Limit file size to 10MB
        request.resource.size < 10 * 1024 * 1024 &&
        // Only allow image files
        request.resource.contentType.matches('image/.*');
    }
    
    // Item images
    match /items/{itemId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        // Verify user owns the item
        exists(/databases/$(database)/documents/items/$(itemId)) &&
        get(/databases/$(database)/documents/items/$(itemId)).data.ownerId == request.auth.uid &&
        // Limit file size to 10MB
        request.resource.size < 10 * 1024 * 1024 &&
        // Only allow image files
        request.resource.contentType.matches('image/.*');
    }
    
    // Chat images
    match /chats/{chatId}/{fileName} {
      allow read: if request.auth != null &&
        exists(/databases/$(database)/documents/chats/$(chatId)) &&
        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      
      allow write: if request.auth != null &&
        exists(/databases/$(database)/documents/chats/$(chatId)) &&
        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
        // Limit file size to 10MB
        request.resource.size < 10 * 1024 * 1024 &&
        // Only allow image files
        request.resource.contentType.matches('image/.*');
    }
    
    // Review images
    match /reviews/{reviewId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        exists(/databases/$(database)/documents/reviews/$(reviewId)) &&
        get(/databases/$(database)/documents/reviews/$(reviewId)).data.reviewerId == request.auth.uid &&
        // Limit file size to 10MB
        request.resource.size < 10 * 1024 * 1024 &&
        // Only allow image files
        request.resource.contentType.matches('image/.*');
    }
    
    // Public assets (category icons, app assets)
    match /public/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null &&
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
